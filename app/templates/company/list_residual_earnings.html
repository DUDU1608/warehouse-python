<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Residual Earnings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f7f8fb; }
    .cell-edit{ display:none; } tr.editing .cell-view{ display:none; } tr.editing .cell-edit{ display:block; }
    .btn-edit{ display:inline-block; } .btn-save,.btn-cancel{ display:none; }
    tr.editing .btn-edit{ display:none; } tr.editing .btn-save, tr.editing .btn-cancel{ display:inline-block; }
  </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-white border-bottom">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#">Company Finance</a>
    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="/company/finance">‚Üê Finance Dashboard</a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('residual_earning.add_earning') }}">Add Earning</a>
    </div>
  </div>
</nav>

<div class="container py-4">
  {% with msgs = get_flashed_messages(with_categories=true) %}
    {% if msgs %}
      {% for cat, msg in msgs %}
      <div class="alert alert-{{ 'warning' if cat=='message' else cat }} alert-dismissible fade show" role="alert">
        {{ msg }} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="fw-bold">üìà Residual Earnings</h3>
    <div class="d-flex gap-2">
      <a class="btn btn-success" href="{{ url_for('residual_earning.add_earning') }}">‚ûï Add Earning</a>
      <a class="btn btn-outline-secondary" href="/company/finance">‚Üê Finance Dashboard</a>
    </div>
  </div>

  <!-- Filters -->
  <form method="GET" class="row g-2 mb-3">
    <div class="col-md-3">
      <label class="form-label">Commodity</label>
      <select name="commodity" class="form-select">
        <option value="">All</option>
        {% for c in commodities %}
          <option value="{{ c }}" {% if request.args.get('commodity')==c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Warehouse</label>
      <select name="warehouse" class="form-select">
        <option value="">All</option>
        {% for w in warehouses %}
          <option value="{{ w }}" {% if request.args.get('warehouse')==w %}selected{% endif %}>{{ w }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">From</label>
      <input type="date" name="from" value="{{ request.args.get('from','') }}" class="form-control">
    </div>
    <div class="col-md-2">
      <label class="form-label">To</label>
      <input type="date" name="to" value="{{ request.args.get('to','') }}" class="form-control">
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button class="btn btn-outline-primary w-100">Go</button>
    </div>
  </form>

  <div class="table-responsive bg-white rounded shadow-sm">
    <table class="table table-striped align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Date</th><th>Warehouse</th><th>Commodity</th>
          <th>Qty</th><th>Rate</th><th>Total Earning</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr data-row>
          <form method="POST" action="{{ url_for('residual_earning.update_earning', rid=r.id) }}" class="row-form">
            <td>
              <div class="cell-view">{{ r.date|format_date }}</div>
              <div class="cell-edit"><input type="date" name="date" class="form-control form-control-sm" value="{{ r.date }}"></div>
            </td>
            <td>
              <div class="cell-view">{{ r.warehouse }}</div>
              <div class="cell-edit"><input name="warehouse" class="form-control form-control-sm" value="{{ r.warehouse }}"></div>
            </td>
            <td>
              <div class="cell-view">{{ r.commodity }}</div>
              <div class="cell-edit"><input name="commodity" class="form-control form-control-sm" value="{{ r.commodity }}"></div>
            </td>
            <td>
              <div class="cell-view">{{ '%.3f'|format(r.quantity) }}</div>
              <div class="cell-edit"><input type="number" step="0.001" name="quantity" class="form-control form-control-sm qty" value="{{ '%.3f'|format(r.quantity) }}"></div>
            </td>
            <td>
              <div class="cell-view">{{ '%.2f'|format(r.rate) }}</div>
              <div class="cell-edit"><input type="number" step="0.01" name="rate" class="form-control form-control-sm rate" value="{{ '%.2f'|format(r.rate) }}"></div>
            </td>
            <td class="fw-semibold">
              <span class="cell-view">{{ r.total_earning|format_inr }}</span>
              <span class="cell-edit live-total">{{ r.total_earning|format_inr }}</span>
            </td>
            <td class="text-end text-nowrap">
              <button type="button" class="btn btn-sm btn-secondary btn-edit">Edit</button>
              <button class="btn btn-sm btn-primary btn-save">Save</button>
              <button type="button" class="btn btn-sm btn-outline-secondary btn-cancel">Cancel</button>
          </form>
              <form method="POST" action="{{ url_for('residual_earning.delete_earning', rid=r.id) }}" class="d-inline" onsubmit="return confirm('Delete this record?');">
                <button class="btn btn-sm btn-outline-danger">Delete</button>
              </form>
            </td>
        </tr>
        {% else %}
        <tr><td colspan="7" class="text-center text-muted py-4">No residual earnings found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
(function(){
  function recalc(tr){
    const qty = parseFloat(tr.querySelector('.qty')?.value || 0);
    const rate = parseFloat(tr.querySelector('.rate')?.value || 0);
    const total = qty * rate;
    const live = tr.querySelector('.live-total');
    if(live){ live.textContent = "‚Çπ " + total.toFixed(2); }
  }
  document.querySelectorAll('tr[data-row]').forEach(function(tr){
    const editBtn = tr.querySelector('.btn-edit');
    const cancelBtn = tr.querySelector('.btn-cancel');
    const qty = tr.querySelector('.qty'); const rate = tr.querySelector('.rate');

    if (editBtn){ editBtn.addEventListener('click', () => { tr.classList.add('editing'); recalc(tr); }); }
    if (cancelBtn){
      cancelBtn.addEventListener('click', () => {
        const form = tr.querySelector('form.row-form'); if (form) form.reset();
        tr.classList.remove('editing'); recalc(tr);
      });
    }
    if (qty) qty.addEventListener('input', () => recalc(tr));
    if (rate) rate.addEventListener('input', () => recalc(tr));
  });
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
