<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Create Invoice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f6f8fb; }
    .card { border-radius: 14px; box-shadow: 0 6px 22px rgba(0,0,0,.06); }
    .table td, .table th { vertical-align: middle; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Create Invoice</h3>
    <a class="btn btn-outline-dark" href="{{ url_for('company_dashboard.finance_dashboard') }}">← Company Finance Dashboard</a>
  </div>

  {% with msgs = get_flashed_messages(with_categories=true) %}
    {% if msgs %}
      {% for cat, msg in msgs %}
        <div class="alert alert-{{ 'warning' if cat=='message' else cat }} alert-dismissible fade show" role="alert">
          {{ msg }} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="card p-3">
    <form method="POST" action="{{ url_for('invoice.create_invoice') }}">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Customer Name *</label>
          <select name="buyer_id" class="form-select" required>
            <option value="">— Select —</option>
            {% for b in buyers %}
              <option value="{{ b.id }}">{{ b.buyer_name }} — {{ b.mobile_no }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Invoice No</label>
          <input class="form-control" value="{{ invoice_no }}" disabled>
        </div>
        <div class="col-md-3">
          <label class="form-label">Date *</label>
          <input type="date" name="date" class="form-control" value="{{ today }}" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Vehicle No</label>
          <input name="vehicle_no" class="form-control" placeholder="WB19J/7944">
        </div>
        <div class="col-md-4">
          <label class="form-label">Driver No</label>
          <input name="driver_no" class="form-control" placeholder="Driver mobile">
        </div>
        <div class="col-md-8">
          <label class="form-label">Address</label>
          <input name="address" class="form-control" placeholder="Customer address (optional)">
        </div>
      </div>

      <hr class="my-3">

      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Descriptions of Goods</h6>
        <button type="button" class="btn btn-sm btn-success" id="addRow">Add Row</button>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered align-middle" id="itemsTable">
          <thead class="table-light">
            <tr>
              <th style="width: 50%;">Description</th>
              <th style="width: 15%;">Price</th>
              <th style="width: 15%;">Qty</th>
              <th style="width: 15%;">Amount</th>
              <th style="width: 5%;">Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- one starter row -->
            <tr>
              <td><input name="item_desc[]" class="form-control" placeholder="e.g., PADDY Hybrid" required></td>
              <td><input type="number" step="0.01" name="item_price[]" class="form-control item-price" required></td>
              <td><input type="number" step="0.01" name="item_qty[]" class="form-control item-qty" required></td>
              <td><input class="form-control item-amount" readonly></td>
              <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger btn-del">×</button></td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <th colspan="3" class="text-end">Grand Total</th>
              <th><input id="grandTotal" class="form-control" readonly></th>
              <th></th>
            </tr>
            <tr>
              <th colspan="3" class="text-end">C. GST</th>
              <th><input value="0.00" class="form-control" readonly></th>
              <th></th>
            </tr>
            <tr>
              <th colspan="3" class="text-end">S. GST</th>
              <th><input value="0.00" class="form-control" readonly></th>
              <th></th>
            </tr>
            <tr>
              <th colspan="3" class="text-end">Sub Total</th>
              <th><input id="subTotal" class="form-control" readonly></th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="text-end">
        <button class="btn btn-primary">Save & Generate PDF</button>
      </div>
    </form>
  </div>
</div>

<script>
function recalcRow(tr){
  const p = parseFloat(tr.querySelector('.item-price')?.value || 0);
  const q = parseFloat(tr.querySelector('.item-qty')?.value || 0);
  const amt = (p * q) || 0;
  tr.querySelector('.item-amount').value = amt.toFixed(2);
}

function recalcTotals(){
  let g = 0;
  document.querySelectorAll('#itemsTable tbody .item-amount').forEach(inp=>{
    g += parseFloat(inp.value || 0);
  });
  document.getElementById('grandTotal').value = g.toFixed(2);
  document.getElementById('subTotal').value = g.toFixed(2); // CGST & SGST are always 0
}

document.getElementById('addRow').addEventListener('click', ()=>{
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input name="item_desc[]" class="form-control" placeholder="Description" required></td>
    <td><input type="number" step="0.01" name="item_price[]" class="form-control item-price" required></td>
    <td><input type="number" step="0.01" name="item_qty[]" class="form-control item-qty" required></td>
    <td><input class="form-control item-amount" readonly></td>
    <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger btn-del">×</button></td>
  `;
  document.querySelector('#itemsTable tbody').appendChild(tr);
});

document.addEventListener('input', (e)=>{
  if (e.target.classList.contains('item-price') || e.target.classList.contains('item-qty')){
    const tr = e.target.closest('tr');
    recalcRow(tr);
    recalcTotals();
  }
});
document.addEventListener('click', (e)=>{
  if (e.target.classList.contains('btn-del')){
    const tr = e.target.closest('tr');
    tr.remove();
    recalcTotals();
  }
});
</script>
</body>
</html>
